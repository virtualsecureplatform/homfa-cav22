# README

## Structure and Content of the Artifact

### In the Zip File

- `README`: This file.
- `LICENSE`: The license of this artifact (Apache License, Version 2.0).
- `homfa_cav22.tar.gz`: The Docker image.

### In the Docker image

- `/package/homfa-experiment/artificial-dfa/`: A directory for the experiment for RQ1.
    - `bench.sh`: A script to execute the experiment.
    - `check_result_correct.sh`: A script to check if the results are correct.
    - `spec/`: A directory for specification files (DFA definitions).
    - `in/`: A directory for input files (binary)
- `/package/homfa-experiment/ap9/`: A directory for the experiment for RQ2
    - `bench.sh`: A script to execute the experiment.
    - `check_result_correct.sh`: A script to check if the results are correct.
    - `*.spec` (Files suffixed with `.spec`): Specification files (DFA definitions).
    - `*.in` (Files suffixed with `.in`): Input files (binary)
- `/log/rq1`: A directory in which the produced logs for RQ1 exist.
- `/log/rq2`: A directory in which the produced logs for RQ2 exist.
- `/package/homfa_src`: A directory for source code.
- `/package/homfa`: A directory for built executable binary files.

## How to Start the Docker Image

1. Execute `docker load < homfa_cav22.tar.gz` to load the Docker image.
1. Execute `docker image ls` to check if the image is correctly loaded and `homfa cav22` is shown in the list.
1. Execute `docker run -it -v $PWD/log:/log homfa:cav22` to start a container of the image and enter it. The commands below are supposed to be executed in the container.
    - Note that the option `-v $PWD/log:/log` above means that the directory `./log` of the host is mounted on `/log` of the guest (container). We will save all the log files in this directory in the following.

## How to Replicate the Results in the Paper

### Which Claims or Results of the Paper can be Replicated with the Artifact

- The results of RQ1 (Figure 4, Table 7, and Table 8)
- The results of RQ2 (Table 5 and Table 9) **except** for the ones for the algorithm Reverse with $\psi_1$ and $\psi_2$
    - We disabled the benchmarks of Reverse with $\psi_1$ and $\psi_2$ because they need a lot of RAM (> 40GiB) and time (> 16,000 seconds), as shown in Table 9. If you want to enable them, please change the last arguments of lines 105 and 106 of `/package/homfa-experiment/ap9/bench.sh` from `0` to `1`.

We note that we obtained the runtimes presented in the paper on a workstation, and they will differ from the ones on a laptop. We also show the runtimes obtained on our laptop for reference in the next section.

We also note that memory usage of all the experiments decreased by around 2.5GiB in comparision to the one in the paper. This is because we fixed a bug which allocates an unnecessary large memory block. We believe that this bug fix does not affect the overall performance of the artifact.

### RQ1

1. Execute `cd /package/homfa-experiment/artificial-dfa/` to change the current directory to the one for RQ1.
1. Execute `./bench.sh /log/rq1` to conduct the experiment for RQ1.
    - After the experiment, you can see two kinds of log files in `/log/rq1`:
        - The files of pattern `(algorithm)_size-(#states)_size-(#inputs).log` (e.g., `bbs-150_size-0010_size-50000bit.log`) show the benchmark result (see below for the format of the files). Note that algorithm `bbs-150` means Block, `reversed` means Reverse, and `plain` means plaintext mode.
        - The files of pattern `(algorithm)_size-(#states)_size-(#inputs)_mem.log` (e.g., `bbs-150_size-0010_size-50000bit_mem.log`) show the output of GNU time.
1. Execute `./check_result_correct.sh /log/rq1` to check if the results are correct.
    - This script compares the output of Block and Reverse with the one of the plaintext mode.
    - If you want to check a log file (say `bbs-150_size-0010_size-50000bit.log`) manually, execute the following commands:
        - `grep "^result" /log/rq1/plain_size-0010_size-50000bit.log > _src`
            - The file `_src` consists of the outputs of plaintext mode.
        - `grep "^result" /log/rq1/bbs-150_size-0010_size-50000bit.log > _dst`
            - The file `_dst` consists of the outputs of the algorithm Block.
        - `diff _src _dst`
            - Nothing should be printed here because we expect `_src` and `_dst` are exactly the same.
1. Execute `ruby sqliteop.rb import res /log/rq1` to import then
    - Execute `ruby sqliteop.rb plot res /log` to plot the results, which will be saved as `/log/res-fixed-input.pdf` and `/log/res-fixed-state.pdf`. These figures correspond to Figure 4 in the paper.
    - Execute `ruby sqliteop.rb table res` to print table of the results as LaTeX code. These tables correspond to Table 7 and 8 in the paper.
    - If you want to remove the imported data for some reason, execute `rm artificial-dfa.sqlite3`.

### RQ2

1. Execute `cd /package/homfa-experiment/ap9/` to change the current directory to the one for RQ2.
2. Execute `./bench.sh /log/rq2` to conduct the experiment for RQ2.
    - After the experiment, you can see two kinds of log files in `/log/rq2`:
        1.  The files of pattern `(algorithm)_(spec)_(input).log` (e.g., `bbs_damon-001.spec_adult-001-7days-bg.in_9.log`) show the benchmark result (see below for the format of the files). Note that the algorithm `bbs` means Block, `reversed` means Reverse, and `plain` means plaintext mode. Also, the spec `damon-X` means $\phi_{X}$ and `towards-X` means $\psi_{X}$.
        1.  The files of pattern `(algorithm)_(spec)_(input)_mem.log` (e.g., `bbs_damon-001.spec_adult-001-7days-bg.in_9_mem.log`) show the output of GNU time.
4. Execute `./check_result_correct.sh /log/rq2` to check if the results are correct.
    - This script compares the output of Block and Reverse with the one of the plaintext mode.
    - If you want to check a log file (say `bbs_damon-001.spec_adult-001-7days-bg.in_9.log`) manually, execute the following commands:
        - `grep "^result" /log/rq2/plain_damon-001.spec_adult-001-7days-bg.in_9.log > _src`
            - The file `_src` consists of the outputs of plaintext mode.
        - `grep "^result" /log/rq2/bbs_damon-001.spec_adult-001-7days-bg.in_9.log > _dst`
            - The file `_dst` consists of the outputs of the algorithm Block.
        - `diff _src _dst`
            - Nothing should be printed here because we expect `_src` and `_dst` are exactly the same.
5. Execute `ruby sqliteop.rb import res /log/rq2` then
    - Execute `ruby sqliteop.rb table res` to print a table of the results as LaTeX code. This table corresponds to Table 5.
    - Execute `ruby sqliteop.rb detailed-table res` to print a detailed table of the results as LaTeX code. This table corresponds to Table 9.
    - If you want to remove the imported data for some reason, execute `rm ap9.sqlite3`.

### Format of Benchmark Results

The benchmark program outputs information and runtimes to the log files (`*.log`) while processing monitored ciphertexts. Each line has one entry, separated by a comma; the first column indicates an entry type, and the following columns are its values.

Some useful types of entries are as follows:

- Type: `result`
    - Values: Output of the algorithm, i.e., 0 or 1.
- Type: `enc`, `run`, `dec`
    - Values: Runtime (in microseconds) of encryption, running the algorithms, and decryption, respectively.

## An Example of Benchmark Results on a Laptop

We obtained the runtimes presented in the paper on a workstation, and they will differ from those on a laptop. Here, we show the runtimes obtained on our laptop for reference.

### System Environment

- CPU: AMD Ryzen 7 PRO 5850U (1.9GHz; 8 cores and 16 threads)
- RAM: 32GiB
- OS: Ubuntu 20.04.4 LTS (WSL2 on Windows 11 Pro (version 21H2))

### Result of the Experiment for RQ1

It took about 40 minutes for `bench.sh` to finish. Here is the result of `ruby sqliteop.rb table`:
```
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                       Table 7: Experimental resutls of M_m when the number of the states (i.e., m) is fixed to 500.                                       |
+-----------+----------------------------+--------------------+-----------------------------+------------------------------------+---------------------+--------------------+
| Algorithm | # of Monitored Ciphertexts | Runtime (CMux) (s) | Runtime (Bootstrapping) (s) | Runtime (CircuitBootstrapping) (s) | Runtime (Total) (s) | Memory Usage (GiB) |
+-----------+----------------------------+--------------------+-----------------------------+------------------------------------+---------------------+--------------------+
| Reverse   | 10000                      | 17.00              | ---                         | ---                                | 17.02               | 0.33               |
| Reverse   | 20000                      | 33.43              | ---                         | ---                                | 33.47               | 0.32               |
| Reverse   | 30000                      | 55.19              | 1.40                        | ---                                | 56.65               | 0.32               |
| Reverse   | 40000                      | 64.12              | 1.20                        | ---                                | 65.39               | 0.33               |
| Reverse   | 50000                      | 79.20              | 1.18                        | ---                                | 80.48               | 0.33               |
| Block     | 10000                      | 17.27              | ---                         | 23.51                              | 41.53               | 2.70               |
| Block     | 20000                      | 38.00              | ---                         | 47.21                              | 86.70               | 2.70               |
| Block     | 30000                      | 57.81              | ---                         | 70.82                              | 130.87              | 2.70               |
| Block     | 40000                      | 66.97              | ---                         | 92.46                              | 162.35              | 2.70               |
| Block     | 50000                      | 83.75              | ---                         | 115.75                             | 203.11              | 2.73               |
+-----------+----------------------------+--------------------+-----------------------------+------------------------------------+---------------------+--------------------+
+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                         Table 8: Experimental results of M_m when the number of monitored ciphertexts (i.e., n) is fixed to 50000.                         |
+-----------+-------------+--------------------+-----------------------------+------------------------------------+---------------------+--------------------+
| Algorithm | # of States | Runtime (CMux) (s) | Runtime (Bootstrapping) (s) | Runtime (CircuitBootstrapping) (s) | Runtime (Total) (s) | Memory Usage (GiB) |
+-----------+-------------+--------------------+-----------------------------+------------------------------------+---------------------+--------------------+
| Reverse   | 10          | 6.04               | 0.03                        | ---                                | 6.11                | 0.32               |
| Reverse   | 50          | 12.14              | 0.12                        | ---                                | 12.31               | 0.33               |
| Reverse   | 100         | 19.31              | 0.25                        | ---                                | 19.62               | 0.32               |
| Reverse   | 200         | 32.82              | 0.50                        | ---                                | 33.37               | 0.32               |
| Reverse   | 300         | 49.51              | 0.71                        | ---                                | 50.30               | 0.32               |
| Reverse   | 400         | 65.11              | 0.98                        | ---                                | 66.17               | 0.32               |
| Reverse   | 500         | 79.20              | 1.18                        | ---                                | 80.48               | 0.33               |
| Block     | 10          | 3.59               | ---                         | 49.93                              | 54.61               | 2.69               |
| Block     | 50          | 8.74               | ---                         | 70.07                              | 80.12               | 2.69               |
| Block     | 100         | 16.12              | ---                         | 85.15                              | 102.82              | 2.69               |
| Block     | 200         | 32.82              | ---                         | 100.55                             | 135.52              | 2.69               |
| Block     | 300         | 49.96              | ---                         | 116.28                             | 168.98              | 2.70               |
| Block     | 400         | 66.70              | ---                         | 116.08                             | 185.93              | 2.70               |
| Block     | 500         | 83.75              | ---                         | 115.75                             | 203.11              | 2.73               |
+-----------+-------------+--------------------+-----------------------------+------------------------------------+---------------------+--------------------+
```

### Result of the Experiment for RQ2

It took about 90 minutes for `bench.sh` to finish. Here is the result of `ruby sqliteop.rb table`:

```
+-------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table 5: Experimental results of blood glucose monitoring, where Q is the state space of the monitoring DFA and Q^R is the state space of the reversed DFA. |
+----------------------+----------------------+----------------------+---------------------------+--------------------+-------------+-------------------------+
| Formula              | |Q|                  | |Q^R|                | # of blood glucose values | Algorithm          | Runtime (s) | Mean Runtime (ms/value) |
+----------------------+----------------------+----------------------+---------------------------+--------------------+-------------+-------------------------+
| psi_1                |                10524 |              2712974 |                       721 | Reverse            |         --- |                     --- |
| psi_1                |                10524 |              2712974 |                       721 | Block              |         --- |                     --- |
| psi_2                |                11126 |              2885376 |                       721 | Reverse            |         --- |                     --- |
| psi_2                |                11126 |              2885376 |                       721 | Block              |         --- |                     --- |
| psi_4                |                 7026 |                  --- |                       721 | Reverse            |         --- |                     --- |
| psi_4                |                 7026 |                  --- |                       721 | Block              |       20.91 |                   29.00 |
+----------------------+----------------------+----------------------+---------------------------+--------------------+-------------+-------------------------+
| phi_1                |                   21 |                   20 |                     10081 | Reverse            |       12.38 |                    1.23 |
| phi_1                |                   21 |                   20 |                     10081 | Block              |      979.44 |                   97.16 |
| phi_4                |                  237 |                  237 |                     10081 | Reverse            |       68.84 |                    6.83 |
| phi_4                |                  237 |                  237 |                     10081 | Block              |     1863.06 |                  184.81 |
| phi_5                |                  390 |                  390 |                     10081 | Reverse            |      108.56 |                   10.77 |
| phi_5                |                  390 |                  390 |                     10081 | Block              |     1868.99 |                  185.40 |
+----------------------+----------------------+----------------------+---------------------------+--------------------+-------------+-------------------------+
```

Here is the result of `ruby sqliteop.rb detailed-table`:

```
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|    Table 9: Experimental results of blood glucose monitoring, where Q is the state space of the monitoring DFA and Q^R is the state space of the reversed DFA.     |
+---------+-------+---------+-------------+-----------+------------------+----------------+------------------+-------------------+------------------------+----------+
| Formula | |Q|   | |Q^R|   | # of values | Algorithm | Runtime(CMux)(s) | Runtime(B.)(s) | Runtime(C.B.)(s) | Runtime(Total)(s) | Mean Runtime(ms/value) | Mem(GiB) |
+---------+-------+---------+-------------+-----------+------------------+----------------+------------------+-------------------+------------------------+----------+
| psi_1   | 10524 | 2712974 |         721 | Reverse   |              --- |            --- |              --- |               --- |                    --- |      --- |
| psi_1   | 10524 | 2712974 |         721 | Block     |              --- |            --- |              --- |               --- |                    --- |      --- |
| psi_2   | 11126 | 2885376 |         721 | Reverse   |              --- |            --- |              --- |               --- |                    --- |      --- |
| psi_2   | 11126 | 2885376 |         721 | Block     |              --- |            --- |              --- |               --- |                    --- |      --- |
| psi_4   |  7026 |     --- |         721 | Reverse   |              --- |            --- |              --- |               --- |                    --- |      --- |
| psi_4   |  7026 |     --- |         721 | Block     |             0.19 |            --- |            11.25 |             20.91 |                  29.00 |     2.80 |
+---------+-------+---------+-------------+-----------+------------------+----------------+------------------+-------------------+------------------------+----------+
| phi_1   |    21 |      20 |       10081 | Reverse   |            12.25 |           0.06 |              --- |             12.38 |                   1.23 |     0.32 |
| phi_1   |    21 |      20 |       10081 | Block     |             5.48 |            --- |           957.07 |            979.44 |                  97.16 |     2.68 |
| phi_4   |   237 |     237 |       10081 | Reverse   |            68.53 |           0.19 |              --- |             68.84 |                   6.83 |     0.33 |
| phi_4   |   237 |     237 |       10081 | Block     |            13.69 |            --- |          1824.20 |           1863.06 |                 184.81 |     2.68 |
| phi_5   |   390 |     390 |       10081 | Reverse   |           108.07 |           0.33 |              --- |            108.56 |                  10.77 |     0.33 |
| phi_5   |   390 |     390 |       10081 | Block     |            17.65 |            --- |          1823.79 |           1868.99 |                 185.40 |     2.69 |
+---------+-------+---------+-------------+-----------+------------------+----------------+------------------+-------------------+------------------------+----------+
```


## Execute the Benchmark with a New Dataset and Specification

In this section, we present how to create a new small specification and data and run the algorithms with them.

1. Execute `cd /package/homfa/bin` to change the current directory to `/package/homfa/bin`.
1. We use an LTL formula $G(p_0\lor p_1)$ as a specification. Execute `./util ltl2spec 'G(p0 | p1)' 2 > _spec` to convert the formula to a DFA and save as `_spec`.
    - `G(p0 | p1)` indicates $G(p_0\lor p_1)$ by using the syntax of Spot (https://spot.lrde.epita.fr/tl.pdf).
    - `2` means the number of atomic propositions is two (`p_0` and `p_1`).
        - Note that atomic propositions must be formed as `p_i`.
1. As input data, we use a sequence such that $p_0$ and $p_1$ alternately hold. Execute `echo -n "10011001" | ruby /package/homfa-experiment/01tobin.rb 2 > _data` to format the data and save as `_data`.
    - `"10011001"` means $p_0$ and $p_1$ hold twice alternately, i.e.,
        - t = 0, 2: $p_0\land\lnot p_1$ holds (encoded as `10`);
        - t = 1, 3: $\lnot p_0\land p_1$ holds (encoded as `01`).
    - Note that this sequence satisfies the specification above.
1. Execute `./benchmark plain --spec _spec --in _data --out-freq 2 --ap 2 > _result_plain` to conduct the monitoring process using `_spec` and `_data` **in plaintext** (plaintext mode). Its output is saved as `_result_plain`, which we use for reference afterwards.
1. Execute `./benchmark reversed --spec _spec --in _data --bootstrapping-freq 30000 --out-freq 2 --ap 2 > _result_reverse` to conduct the **oblivious** monitoring process using `_spec` and `_data` with the algorithm **Reverse**. Its output is saved as `_result_reverse`.
1. Execute `./benchmark bbs --spec _spec --in _data --out-freq 2 --ap 2 --queue-size 2 > _result_block` to conduct the **oblivious** monitoring process using `_spec` and `_data` with the algorithm **Block**. Its output is saved as `_result_block`.
1. Check if the outputs are correct:
    - Execute `cat _result_plain`, `cat _result_reverse`, and `cat _result_block` to inspect the outputs. All of these files should have exact **four** lines of `result,1` which corresponds to the outputs of $t=0,1,2,3$.
1. Calculate runtimes:
    - Execute `/package/homfa-experiment/summarize-benchmark-result.sh _result_reverse` for Reverse.
    - Execute `/package/homfa-experiment/summarize-benchmark-result.sh _result_block` for Block.

## Source Code

The source code is located at `/package/homfa`.

The most relevant and interesting parts are:
- `/package/homfa_src/src/backstream_dfa_runner.cpp`, line 44--79 (`BackstreamDFARunner::eval`)
    - This is the function `BackstreamDFARunner::eval`, which implements the algorithm Reverse. Given a monitored ciphertext `input` as an argument, it executes one iteration of the main loop (lines 4--12 in Algorithm 3) using the input. More precisely, it applies `CMux` to all the states (note that `input_size_` in line 50 always evaluates to `false` here), and it evaluates `Bootstrapping` every `boot_interval_` consumption of the monitored ciphertexts.
- `/package/homfa_src/src/online_dfa.cpp`, line 97--224 (`OnlineDFARunner4::eval_queued_inputs`)
    - This is the function `OnlineDFARunner4::eval_queued_inputs`, which implements the algorithm Block. It conducts one iteration of the main loop (lines 3--19 in Algorithm 4) using a block of monitored ciphertexts (`queued_inputs_`). More precisely, it computes the states reachable from the initial state at the current block, applies `CMux` to all the states and the monitored ciphertexts of the block, and constructs a ciphertext representing the current state of the DFA for the next iteration.

## Relevant Log Files

The files are located at `/log/rq1` and `/log/rq2` for RQ1 and RQ2, respectively.

